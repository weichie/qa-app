var socket=io("/qa-app");socket.emit("chat message","hello");var app=angular.module("qaApp",["ui.router"]);app.filter("ifImage",function(){return function(e){var o=(new RegExp("(.png|.jpg|.gif|.jpeg)"),e);geturl=new RegExp("(^|[ 	\r\n])((http|https):(([A-Za-z0-9$_.+!*(),;/?:@&~=-])|%[A-Fa-f0-9]{2}){2,}(#([a-zA-Z0-9][a-zA-Z0-9$_.+!*(),;/?:@&~=%-]*))?([A-Za-z0-9$_+!*();/?:~-]))","g");var n=o.match(geturl);if(console.log(n),null!==n){for(var t=e,s=0;s<n.length;s++)console.log(n[s]),console.log(t),t=t.replace(n[s],'<img src="'+n[s]+'">'),console.log(t);return o=t}return o=e}}),app.filter("reverse",function(){return function(e){return e.slice().reverse()}}),app.filter("sanitize",["$sce",function(e){return function(o){return e.trustAsHtml(o)}}]),app.factory("auth",["$http","$window",function(e,o){var n={};return n.saveToken=function(e){o.localStorage["qa-token"]=e},n.getToken=function(){return o.localStorage["qa-token"]},n.isLoggedIn=function(){var e=n.getToken();if(e){var t=JSON.parse(o.atob(e.split(".")[1]));return t.exp>Date.now()/1e3}return!1},n.currentUserId=function(){if(n.isLoggedIn()){var e=n.getToken(),t=JSON.parse(o.atob(e.split(".")[1]));return t._id}},n.currentUser=function(){if(n.isLoggedIn()){var e=n.getToken(),t=JSON.parse(o.atob(e.split(".")[1]));return t.username}},n.register=function(o){return e.post("/register",o).success(function(e){n.saveToken(e.token)})},n.logIn=function(o){return e.post("/login",o).success(function(e){n.saveToken(e.token)})},n.logout=function(e){o.localStorage.removeItem("qa-token")},n}]),app.factory("discussions",["$http","auth",function(e,o){var n={discussions:[]};return n.getAll=function(){return e.get("/discussion").success(function(e){angular.copy(e,n.discussions)})},n.get=function(o){return e.get("/discussion/"+o).then(function(e){return e.data})},n.closeDiscussion=function(n){return e.put("/discussion/"+n._id+"/close",n,{headers:{Authorization:"Bearer "+o.getToken()}})},n.create=function(t){return e.post("/discussion",t,{headers:{Authorization:"Bearer "+o.getToken()}}).success(function(e){n.discussions.push(e)})},n.addQuestion=function(n,t){return e.post("/discussion/"+n+"/questions",t,{headers:{Authorization:"Bearer "+o.getToken()}})},n}]),app.factory("questions",["$http","auth",function(e,o){var n={questions:[]};return n.getAll=function(){return e.get("/question").success(function(e){angular.copy(e,n.questions)})},n.get=function(o){return e.get("/question/"+o).then(function(e){return e.data})},n.plusOne=function(n){return e.put("/question/"+n._id+"/upvote",null,{headers:{Authorization:"Bearer "+o.getToken()}}).success(function(e){n.upvotes+=1})},n.minOne=function(n){return e.put("/question/"+n._id+"/downvote",null,{headers:{Authorization:"Bearer "+o.getToken()}}).success(function(e){n.upvotes-=1})},n.plusOneAnswer=function(n,t){return e.put("/question/"+n._id+"/answers/"+t._id+"/upvote",null,{headers:{Authorization:"Bearer "+o.getToken()}}).success(function(e){t.upvotes+=1})},n.minOneAnswer=function(n,t){return e.put("/question/"+n._id+"/answers/"+t._id+"/downvote",null,{headers:{Authorization:"Bearer "+o.getToken()}}).success(function(e){t.upvotes-=1})},n.create=function(t){return e.post("/question",t,{headers:{Authorization:"Bearer "+o.getToken()}}).success(function(e){n.questions.push(e)})},n.addComment=function(n,t){return e.post("/question/"+n+"/answers",t,{headers:{Authorization:"Bearer "+o.getToken()}})},n.removeComment=function(n){return e.put("/answer/"+n._id,n,{headers:{Authorization:"Bearer "+o.getToken()}})},n}]),app.controller("MainCtrl",["$scope","questions","auth","$window","discussions",function(e,o,n,t,s){o.getAll(),e.q=o.questions,s.getAll(),e.discussions=s.discussions;var i=function(){return n.currentUser()?n.currentUser():"anonymous"};console.log(t.socket),t.socket.emit("joinDiscussion",{discussion:"homepage",user:i()}),e.plusOne=function(e){o.plusOne(e)},e.minOne=function(e){o.minOne(e)},e.addQuestion=function(){e.title&&""!==e.title&&(o.create({title:e.title,link:e.link}),e.title="",e.link="")},n.isLoggedIn()&&(e.username=n.currentUser()),t.socket.on("pushQuestions",function(){o.getAll().then(function(o){console.log(o),e.q=o.data})}),e.logout=function(){n.logout()},e.isLoggedIn=n.isLoggedIn,console.log(n.getToken()),console.log(n.currentUser()),console.log(n.currentUserId()),console.log(n.isLoggedIn())}]),app.controller("DiscussionCtrl",["$scope","$window","$stateParams","discussions","questions","discussion","auth",function(e,o,n,t,s,i,u){e.discussion=i,e.answer={},e.isClosed=i.closed;var r=function(){return u.currentUser()?u.currentUser():"anonymous"};o.socket.emit("joinDiscussion",{discussion:i._id,user:r()}),e.isLoggedIn=u.isLoggedIn,e.isAdmin=function(){return u.currentUserId()===i.owner},o.socket.on("changedQuestion",function(o){console.log("seems that someone changed this question..."),console.log(" man man man "),console.log(o),t.get(i._id).then(function(o){console.log(o),e.discussion=o})}),e.trash=function(n,t,u){console.log(n),console.log(t),console.log(u),n.discussion=i._id,s.removeComment(n).success(function(){e.discussion.questions[t].answers.splice(u,1),o.socket.emit("changedQuestion",i)})},e.close=function(){t.closeDiscussion(i).success(function(){e.isClosed=!0,o.socket.emit("changedQuestion",i)})},e.addQuestion=function(){e.body&&""!==e.body&&(t.addQuestion(i._id,{body:e.body}).success(function(n){e.discussion.questions.push(n),o.socket.emit("changedQuestion",i)}),e.body="")},e.addAnswer=function(n,t){e.answer[t].body&&""!==e.answer[t].body&&(s.addComment(n,{body:e.answer[t].body}).success(function(n){e.discussion.questions[t].answers.push(n),o.socket.emit("changedQuestion",i)}),e.answer[t].body="")},o.socket.on("peopleNames",function(o){console.log(o),e.loggedInPeople=o}),Object.size=function(e){var o,n=0;for(o in e)e.hasOwnProperty(o)&&n++;return n},o.socket.on("rooms",function(o){var n=[];if("undefined"!=typeof o[i._id])for(_socket in o[i._id].sockets){console.log("scoket :"+_socket);for(var t=0;t<e.loggedInPeople.length;t++)console.log("person"+e.loggedInPeople[t].socket),e.loggedInPeople[t].socket==_socket&&(console.log(e.loggedInPeople[t].user),n.push(e.loggedInPeople[t].user))}console.log(n),e.people=n.join(),e.$apply()})}]),app.controller("QuestionCtrl",["$scope","$window","$stateParams","questions","question","auth",function(e,o,n,t,s,i){e.question=s,e.isLoggedIn=i.isLoggedIn,e.isAdmin=function(){return i.currentUserId()===s.owner},console.log(e.isAdmin()),console.log(e.question),o.socket.on("changedQuestion",function(o){console.log("seems that someone changed this question..."),console.log(" man man man "),console.log(o),t.get(s._id).then(function(o){console.log(o),e.question=o})}),e.plusOne=function(e){o.socket.emit("changedQuestion",e),o.socket.emit("pushQuestions",e),t.plusOne(e)},e.minOne=function(e){o.socket.emit("changedQuestion",e),o.socket.emit("pushQuestions",e),t.minOne(e)},e.addComment=function(){e.body&&""!==e.body&&(t.addComment(s._id,{body:e.body,author:"user"}).success(function(n){e.question.answers.push(n),o.socket.emit("changedQuestion",s)}),e.body="")},e.plusOneAnswer=function(e,n){o.socket.emit("changedQuestion",e),t.plusOneAnswer(e,n)},e.minOneAnswer=function(e,n){o.socket.emit("changedQuestion",e),t.minOneAnswer(e,n)}}]),app.controller("AddDiscussionCtrl",["$scope","discussions","auth","$window",function(e,o,n,t){e.isLoggedIn=n.isLoggedIn,e.supportsGeo=t.navigator,e.position=null,window.navigator.geolocation.getCurrentPosition(function(o){$.get("http://maps.googleapis.com/maps/api/geocode/json?address="+o.coords.latitude+","+o.coords.longitude+"&sensor=false",function(n){console.log(n),e.$apply(function(){e.position=o.coords.latitude+";"+o.coords.longitude,e.city=n.results[2].formatted_address})})},function(e){alert(e)}),e.addDiscussion=function(){e.title&&""!==e.title&&(o.create({title:e.title,location:e.position,city:e.city}),t.socket.emit("pushQuestions"),e.title="")}}]),app.controller("AddqCtrl",["$scope","questions","auth",function(e,o,n){e.q=o.questions,e.isLoggedIn=n.isLoggedIn,e.addQuestion=function(){e.title&&""!==e.title&&(o.create({title:e.title,link:e.link,body:e.body}),$window.socket.emit("pushQuestions"),e.title="",e.link="",e.body="")}}]),app.controller("AuthCtrl",["$scope","$state","auth",function(e,o,n){e.user={},e.register=function(){n.register(e.user).error(function(o){e.error=o}).then(function(){o.go("home")})},e.logIn=function(){n.logIn(e.user).error(function(o){e.error=o}).then(function(){o.go("home")})}}]),app.controller("NavCtrl",["$scope","auth","$window",function(e,o,n){e.isLoggedIn=o.isLoggedIn,e.currentUser=o.currentUser,e.logOut=o.logOut,e.rooms,e.logOut=function(){o.logout()}}]),app.controller("SidebarCtrl",["$scope","discussions","$window",function(e,o,n){o.getAll(),e.discussions=o.discussions,e.checkOnline={},setTimeout(function(){console.log(e.discussions)},2500),n.socket.on("peopleNames",function(e){console.log(e)}),Object.size=function(e){var o,n=0;for(o in e)e.hasOwnProperty(o)&&n++;return n},n.socket.on("rooms",function(o){console.log(o),e.rooms=o,e.checkOnline={};for(var n=0;n<e.discussions.length;n++)console.log(e.discussions[n]._id),"undefined"!=typeof o[e.discussions[n]._id]?e.checkOnline[e.discussions[n]._id]=Object.size(o[e.discussions[n]._id].sockets):e.checkOnline[e.discussions[n]._id]=0;console.log(e.checkOnline),e.$apply()})}]),app.config(["$stateProvider","$urlRouterProvider",function(e,o){e.state("home",{url:"/home",templateUrl:"/home.html",controller:"MainCtrl",resolve:{postPromise:["questions",function(e){return e.getAll()}]}}).state("question",{url:"/question/{id}",templateUrl:"/question.html",controller:"QuestionCtrl",resolve:{question:["$stateParams","questions",function(e,o){return o.get(e.id)}]}}).state("discussion",{url:"/discussion/{id}",templateUrl:"/discussion.html",controller:"DiscussionCtrl",resolve:{discussion:["$stateParams","discussions",function(e,o){return o.get(e.id)}]}}).state("addQuestion",{url:"/addQuestion",templateUrl:"/addQuestion.html",controller:"AddqCtrl"}).state("addDiscussion",{url:"/addDiscussion",templateUrl:"/addDiscussion.html",controller:"AddDiscussionCtrl"}).state("login",{url:"/login",templateUrl:"/login.html",controller:"AuthCtrl",onEnter:["$state","auth",function(e,o){o.isLoggedIn()&&e.go("home")}]}).state("register",{url:"/register",templateUrl:"/register.html",controller:"AuthCtrl",onEnter:["$state","auth",function(e,o){o.isLoggedIn()&&e.go("home")}]}),o.otherwise("home")}]);
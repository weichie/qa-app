var app=angular.module("qaApp",["ui.router"]);app.filter("ifImage",function(){return function(e){var n=(new RegExp("(.png|.jpg|.gif|.jpeg)"),e);geturl=new RegExp("(^|[ 	\r\n])((http|https):(([A-Za-z0-9$_.+!*(),;/?:@&~=-])|%[A-Fa-f0-9]{2}){2,}(#([a-zA-Z0-9][a-zA-Z0-9$_.+!*(),;/?:@&~=%-]*))?([A-Za-z0-9$_+!*();/?:~-]))","g");var o=n.match(geturl);if(console.log(o),null!==o){for(var s=e,t=0;t<o.length;t++)console.log(o[t]),console.log(s),s=s.replace(o[t],'<img src="'+o[t]+'">'),console.log(s);return n=s}return n=e}}),app.filter("reverse",function(){return function(e){return e.slice().reverse()}}),app.filter("sanitize",["$sce",function(e){return function(n){return e.trustAsHtml(n)}}]),app.factory("auth",["$http","$window",function(e,n){var o={};return o.saveToken=function(e){n.localStorage["qa-token"]=e},o.getToken=function(){return n.localStorage["qa-token"]},o.isLoggedIn=function(){var e=o.getToken();if(e){var s=JSON.parse(n.atob(e.split(".")[1]));return s.exp>Date.now()/1e3}return!1},o.currentUserId=function(){if(o.isLoggedIn()){var e=o.getToken(),s=JSON.parse(n.atob(e.split(".")[1]));return s._id}},o.currentUser=function(){if(o.isLoggedIn()){var e=o.getToken(),s=JSON.parse(n.atob(e.split(".")[1]));return s.username}},o.register=function(n){return e.post("/register",n).success(function(e){o.saveToken(e.token)})},o.logIn=function(n){return e.post("/login",n).success(function(e){o.saveToken(e.token)})},o.logout=function(e){n.localStorage.removeItem("qa-token")},o}]),app.factory("discussions",["$http","auth",function(e,n){var o={discussions:[]};return o.getAll=function(){return e.get("/discussion").success(function(e){angular.copy(e,o.discussions)})},o.get=function(n){return e.get("/discussion/"+n).then(function(e){return e.data})},o.closeDiscussion=function(o){return e.put("/discussion/"+o._id+"/close",o,{headers:{Authorization:"Bearer "+n.getToken()}})},o.create=function(s){return e.post("/discussion",s,{headers:{Authorization:"Bearer "+n.getToken()}}).success(function(e){o.discussions.push(e)})},o.addQuestion=function(o,s){return e.post("/discussion/"+o+"/questions",s,{headers:{Authorization:"Bearer "+n.getToken()}})},o}]),app.factory("questions",["$http","auth",function(e,n){var o={questions:[]};return o.getAll=function(){return e.get("/question").success(function(e){angular.copy(e,o.questions)})},o.get=function(n){return e.get("/question/"+n).then(function(e){return e.data})},o.plusOne=function(o){return e.put("/question/"+o._id+"/upvote",null,{headers:{Authorization:"Bearer "+n.getToken()}}).success(function(e){o.upvotes+=1})},o.minOne=function(o){return e.put("/question/"+o._id+"/downvote",null,{headers:{Authorization:"Bearer "+n.getToken()}}).success(function(e){o.upvotes-=1})},o.plusOneAnswer=function(o,s){return e.put("/question/"+o._id+"/answers/"+s._id+"/upvote",null,{headers:{Authorization:"Bearer "+n.getToken()}}).success(function(e){s.upvotes+=1})},o.minOneAnswer=function(o,s){return e.put("/question/"+o._id+"/answers/"+s._id+"/downvote",null,{headers:{Authorization:"Bearer "+n.getToken()}}).success(function(e){s.upvotes-=1})},o.create=function(s){return e.post("/question",s,{headers:{Authorization:"Bearer "+n.getToken()}}).success(function(e){o.questions.push(e)})},o.addComment=function(o,s){return e.post("/question/"+o+"/answers",s,{headers:{Authorization:"Bearer "+n.getToken()}})},o.removeComment=function(o){return e.put("/answer/"+o._id,o,{headers:{Authorization:"Bearer "+n.getToken()}})},o}]),app.controller("MainCtrl",["$scope","questions","auth","$window","discussions",function(e,n,o,s,t){n.getAll(),e.q=n.questions,t.getAll(),e.discussions=t.discussions;var i=function(){return o.currentUser()?o.currentUser():"anonymous"};console.log(s.socket),s.socket.emit("joinDiscussion",{discussion:"homepage",user:i()}),e.plusOne=function(e){n.plusOne(e)},e.minOne=function(e){n.minOne(e)},e.addQuestion=function(){e.title&&""!==e.title&&(n.create({title:e.title,link:e.link}),e.title="",e.link="")},o.isLoggedIn()&&(e.username=o.currentUser()),s.socket.on("pushQuestions",function(){n.getAll().then(function(n){console.log(n),e.q=n.data})}),e.logout=function(){o.logout()},e.isLoggedIn=o.isLoggedIn,console.log(o.getToken()),console.log(o.currentUser()),console.log(o.currentUserId()),console.log(o.isLoggedIn())}]),app.controller("DiscussionCtrl",["$scope","$window","$stateParams","discussions","questions","discussion","auth",function(e,n,o,s,t,i,u){e.discussion=i,e.answer={},e.isClosed=i.closed;var r=function(){return u.currentUser()?u.currentUser():"anonymous"};n.socket.emit("joinDiscussion",{discussion:i._id,user:r()}),e.isLoggedIn=u.isLoggedIn,e.isAdmin=function(){return u.currentUserId()===i.owner},n.socket.on("changedQuestion",function(n){console.log("seems that someone changed this question..."),console.log(" man man man "),console.log(n),s.get(i._id).then(function(n){console.log(n),e.discussion=n})}),e.trash=function(o,s,u){console.log(o),console.log(s),console.log(u),o.discussion=i._id,t.removeComment(o).success(function(){e.discussion.questions[s].answers.splice(u,1),n.socket.emit("changedQuestion",i)})},e.close=function(){s.closeDiscussion(i).success(function(){e.isClosed=!0,n.socket.emit("changedQuestion",i)})},e.addQuestion=function(){e.body&&""!==e.body&&(s.addQuestion(i._id,{body:e.body}).success(function(o){e.discussion.questions.push(o),n.socket.emit("changedQuestion",i)}),e.body="")},e.addAnswer=function(o,s){e.answer[s].body&&""!==e.answer[s].body&&(t.addComment(o,{body:e.answer[s].body}).success(function(o){e.discussion.questions[s].answers.push(o),n.socket.emit("changedQuestion",i)}),e.answer[s].body="")},n.socket.on("peopleNames",function(n){console.log(n),e.loggedInPeople=n}),Object.size=function(e){var n,o=0;for(n in e)e.hasOwnProperty(n)&&o++;return o},n.socket.on("rooms",function(n){var o=[];if("undefined"!=typeof n[i._id])for(_socket in n[i._id].sockets){console.log("scoket :"+_socket);for(var s=0;s<e.loggedInPeople.length;s++)console.log("person"+e.loggedInPeople[s].socket),e.loggedInPeople[s].socket==_socket&&(console.log(e.loggedInPeople[s].user),o.push(e.loggedInPeople[s].user))}console.log(o),e.people=o.join(),e.$apply()}),console.log(e.discussion),e.plusOneAnswer=function(e,o){n.socket.emit("changedQuestion",o),t.plusOneAnswer(o,e)},e.minOneAnswer=function(e,o){n.socket.emit("changedQuestion",o),t.minOneAnswer(o,e)}}]),app.controller("QuestionCtrl",["$scope","$window","$stateParams","questions","question","auth",function(e,n,o,s,t,i){e.question=t,e.isLoggedIn=i.isLoggedIn,e.isAdmin=function(){return i.currentUserId()===t.owner},console.log(e.isAdmin()),console.log(e.question),n.socket.on("changedQuestion",function(n){console.log("seems that someone changed this question..."),console.log(" man man man "),console.log(n),s.get(t._id).then(function(n){console.log(n),e.question=n})}),e.plusOne=function(e){n.socket.emit("changedQuestion",e),n.socket.emit("pushQuestions",e),s.plusOne(e)},e.minOne=function(e){n.socket.emit("changedQuestion",e),n.socket.emit("pushQuestions",e),s.minOne(e)},e.addComment=function(){e.body&&""!==e.body&&(s.addComment(t._id,{body:e.body,author:"user"}).success(function(o){e.question.answers.push(o),n.socket.emit("changedQuestion",t)}),e.body="")},e.plusOneAnswer=function(e,o){n.socket.emit("changedQuestion",e),s.plusOneAnswer(e,o)},e.minOneAnswer=function(e,o){n.socket.emit("changedQuestion",e),s.minOneAnswer(e,o)}}]),app.controller("AddDiscussionCtrl",["$scope","discussions","auth","$window",function(e,n,o,s){e.isLoggedIn=o.isLoggedIn,e.supportsGeo=s.navigator,e.position=null,window.navigator.geolocation.getCurrentPosition(function(n){$.get("http://maps.googleapis.com/maps/api/geocode/json?address="+n.coords.latitude+","+n.coords.longitude+"&sensor=false",function(o){console.log(o),e.$apply(function(){e.position=n.coords.latitude+";"+n.coords.longitude,e.city=o.results[2].formatted_address})})},function(e){alert(e)}),e.addDiscussion=function(){e.title&&""!==e.title&&(n.create({title:e.title,location:e.position,city:e.city}),s.socket.emit("pushQuestions"),e.title="")}}]),app.controller("AddqCtrl",["$scope","questions","auth",function(e,n,o){e.q=n.questions,e.isLoggedIn=o.isLoggedIn,e.addQuestion=function(){e.title&&""!==e.title&&(n.create({title:e.title,link:e.link,body:e.body}),$window.socket.emit("pushQuestions"),e.title="",e.link="",e.body="")}}]),app.controller("AuthCtrl",["$scope","$state","auth",function(e,n,o){e.user={},e.register=function(){o.register(e.user).error(function(n){e.error=n}).then(function(){n.go("home")})},e.logIn=function(){o.logIn(e.user).error(function(n){e.error=n}).then(function(){n.go("home")})}}]),app.controller("NavCtrl",["$scope","auth","$window",function(e,n,o){e.isLoggedIn=n.isLoggedIn,e.currentUser=n.currentUser,e.logOut=n.logOut,e.rooms,e.logOut=function(){n.logout()}}]),app.controller("SidebarCtrl",["$scope","discussions","$window",function(e,n,o){n.getAll(),e.discussions=n.discussions,e.checkOnline={},setTimeout(function(){console.log(e.discussions)},2500),o.socket.on("peopleNames",function(e){console.log(e)}),Object.size=function(e){var n,o=0;for(n in e)e.hasOwnProperty(n)&&o++;return o},o.socket.on("rooms",function(n){console.log(n),e.rooms=n,e.checkOnline={};for(var o=0;o<e.discussions.length;o++)console.log(e.discussions[o]._id),"undefined"!=typeof n[e.discussions[o]._id]?e.checkOnline[e.discussions[o]._id]=Object.size(n[e.discussions[o]._id].sockets):e.checkOnline[e.discussions[o]._id]=0;console.log(e.checkOnline),e.$apply()})}]),app.config(["$stateProvider","$urlRouterProvider",function(e,n){e.state("home",{url:"/home",templateUrl:"/home.html",controller:"MainCtrl",resolve:{postPromise:["questions",function(e){return e.getAll()}]}}).state("question",{url:"/question/{id}",templateUrl:"/question.html",controller:"QuestionCtrl",resolve:{question:["$stateParams","questions",function(e,n){return n.get(e.id)}]}}).state("discussion",{url:"/discussion/{id}",templateUrl:"/discussion.html",controller:"DiscussionCtrl",resolve:{discussion:["$stateParams","discussions",function(e,n){return n.get(e.id)}]}}).state("addQuestion",{url:"/addQuestion",templateUrl:"/addQuestion.html",controller:"AddqCtrl"}).state("addDiscussion",{url:"/addDiscussion",templateUrl:"/addDiscussion.html",controller:"AddDiscussionCtrl"}).state("login",{url:"/login",templateUrl:"/login.html",controller:"AuthCtrl",onEnter:["$state","auth",function(e,n){n.isLoggedIn()&&e.go("home")}]}).state("register",{url:"/register",templateUrl:"/register.html",controller:"AuthCtrl",onEnter:["$state","auth",function(e,n){n.isLoggedIn()&&e.go("home")}]}),n.otherwise("home")}]);var socket=io("/qa-app");socket.emit("chat message","hello");